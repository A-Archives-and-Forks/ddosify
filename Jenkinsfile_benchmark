pipeline {
  agent {
    dockerfile {
      label 'performance-test'
      filename '.devcontainer/Dockerfile.dev'
    }
  }

  options { 
    disableConcurrentBuilds() 
  }

  stages {
    stage('Performance Test') {
      steps {
        lock('multi_branch_server_benchmark') {
          sh 'GOCACHE=/tmp/ go test -benchmem -cpuprofile=cpu.out -memprofile=mem.out -trace=trace.out -run=^$ -bench ^BenchmarkEngines$ -count 1'
        }
      }
    }
  }
  post {
    always {
            archiveArtifacts artifacts: '*.out', fingerprint: true
        }
  //   unstable {
  //     slackSend(channel: '#jenkins', color: 'danger', message: "${currentBuild.currentResult}: ${currentBuild.fullDisplayName} - ${BUILD_URL}")
  //   }

  //   failure {
  //     slackSend(channel: '#jenkins', color: 'danger', message: "${currentBuild.currentResult}: ${currentBuild.fullDisplayName} - ${BUILD_URL}")
  //   }
  }
}
