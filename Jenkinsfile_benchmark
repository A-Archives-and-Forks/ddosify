pipeline {
  agent {
    dockerfile {
      label 'performance-test'
      filename '.devcontainer/Dockerfile.dev'
    }
  }

  options { 
    disableConcurrentBuilds() 
  }

  stages {
    stage('Performance Test') {
      steps {
        lock('multi_branch_server_benchmark') {
          sh 'GOCACHE=/tmp/ go test -benchmem -cpuprofile=cpu.out -memprofile=mem.out -trace=trace.out -run=^$ -bench ^BenchmarkEngines$ -count 1 | tee gobench_branch.txt'
        }
      }
    }
    stage('Performance Test Develop') {
      when {
        // Run on only PR
        allOf {
          expression { env.CHANGE_ID != null }
          expression { env.CHANGE_TARGET != null }
        }
      }
      steps {
        lock('multi_branch_server_benchmark') {
          sh 'git fetch origin develop:develop ||  git checkout develop && git pull && GOCACHE=/tmp/ go test -benchmem -cpuprofile=cpu_develop.out -memprofile=mem_develop.out -trace=trace_develop.out -run=^$ -bench ^BenchmarkEngines$ -count 1 | tee gobench_develop.txt'
          sh "git checkout ${BRANCH_NAME}"
          sh "benchstat -alpha 1.01 --sort delta gobench_develop.txt gobench_branch.txt | tee gobench_branch_result.txt"
          sh "benchstat -alpha 1.01 --sort delta --html gobench_develop.txt gobench_branch.txt > 00_gobench_result.html && echo ${BUILD_URL}artifact/00_gobench_result.html"
          sh "./scripts/testing/benchstat.sh"
          withCredentials([usernamePassword(credentialsId: 'ddosifyadmin_comment_github_access', passwordVariable: 'GITHUB_TOKEN', usernameVariable: 'GITHUB_USERNAME')]) {
            sh """#!/bin/bash
              github_comment=`jq -Rs '.' benchstat.txt`
              echo $github_comment
              curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                              -X POST -d "{\"body\": $github_comment}" \
                              "https://api.github.com/repos/ddosify/ddosify/issues/${env.CHANGE_ID}/comments"
            """
          }
        }
      }
    }
  }
  post {
    always {
      archiveArtifacts artifacts: '*.out', fingerprint: true
      archiveArtifacts artifacts: 'gobench_*.txt', fingerprint: true
      archiveArtifacts artifacts: '00_gobench_result.html', fingerprint: true, allowEmptyArchive: true
    }
  //   unstable {
  //     slackSend(channel: '#jenkins', color: 'danger', message: "${currentBuild.currentResult}: ${currentBuild.fullDisplayName} - ${BUILD_URL}")
  //   }

  //   failure {
  //     slackSend(channel: '#jenkins', color: 'danger', message: "${currentBuild.currentResult}: ${currentBuild.fullDisplayName} - ${BUILD_URL}")
  //   }
  }
}
